<!DOCTYPE html>
<html>
<head>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 20px;
      padding-bottom: 100px;
      background: #fafafa;
      color: #1a1a1a;
      margin: 0;
      min-height: 100vh;
      overflow-y: auto;
    }
    
    h2 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #1a1a1a;
      letter-spacing: -0.01em;
    }
    
    .info-box {
      padding: 12px 16px;
      background: #f5f5f5;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #666;
      border: 1px solid #e5e5e5;
    }
    
    .info-box.warning {
      background: #fff8e1;
      color: #b8860b;
      border-color: #ffd54f;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #000000;
    }
    
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      background: #ffffff;
      color: #1a1a1a;
      transition: all 0.2s ease;
    }
    
    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #666;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }
    
    .variants-list {
      margin-bottom: 16px;
    }
    
    .variant-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .variant-item input[type="text"] {
      flex: 1;
    }
    
    .variant-item input[type="number"] {
      width: 80px;
    }
    
    .variant-item input[type="number"].stroke-input {
      width: 70px;
    }
    
    .variant-item input[type="number"].stroke-input:disabled {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }
    
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .toggle-switch {
      position: relative;
      width: 36px;
      height: 20px;
      background: #d0d0d0;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s ease;
      flex-shrink: 0;
    }
    
    .toggle-switch.active {
      background: #2a2a2a;
    }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: transform 0.2s ease;
    }
    
    .toggle-switch.active::after {
      transform: translateX(16px);
    }
    
    .stroke-toggle-section {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: #fafafa;
      border-radius: 6px;
      border: 1px solid #e5e5e5;
    }
    
    .stroke-toggle-section label {
      margin: 0;
      font-size: 13px;
      font-weight: 500;
      color: #1a1a1a;
      flex: 1;
    }
    
    .remove-btn {
      background: #2a2a2a;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      padding: 8px;
      cursor: pointer;
      font-size: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .remove-btn:hover {
      background: #1a1a1a;
    }
    
    .remove-btn:active {
      transform: scale(0.95);
    }
    
    .remove-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }
    
    .add-btn {
      background: #2a2a2a;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      width: 100%;
      margin-bottom: 20px;
      transition: all 0.2s ease;
    }
    
    .add-btn:hover {
      background: #1a1a1a;
    }
    
    .add-btn:active {
      transform: scale(0.98);
    }
    
    .actions {
      display: flex;
      gap: 8px;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 20px;
      background: #fafafa;
      border-top: 1px solid #e5e5e5;
      z-index: 100;
    }
    
    .btn-primary {
      flex: 1;
      background: #1a1a1a;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
      background: #000000;
    }
    
    .btn-primary:active {
      transform: scale(0.98);
    }
    
    .btn-primary:disabled {
      background: #d0d0d0;
      color: #999;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: #1a1a1a;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-secondary:hover {
      background: #e8e8e8;
      border-color: #b0b0b0;
    }
    
    .btn-secondary:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>
  <h2>Create Icon Component</h2>
  
  <div id="info-box" class="info-box warning">
    Please select an icon in Figma
  </div>
  
  <div class="form-group">
    <label for="component-name">Component Name</label>
    <input type="text" id="component-name" placeholder="Icon Component">
  </div>
  
  <div class="form-group">
    <label for="property-name">Property Name</label>
    <input type="text" id="property-name" placeholder="Size">
  </div>
  
  <div class="form-group">
    <label>Variants</label>
    <div id="variants-list" class="variants-list">
      <!-- Variants will be added here dynamically -->
    </div>
    <button class="add-btn" id="add-variant">+ Add Variant</button>
  </div>
  
  <div class="form-group">
    <label style="margin-bottom: 12px;">Settings</label>
    <div class="stroke-toggle-section">
      <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; gap: 10px;">
        <label for="stroke-toggle" style="margin: 0;">Enable Stroke</label>
        <div class="toggle-switch" id="stroke-toggle"></div>
      </div>
      
      <div style="width: 100%; height: 1px; background: #e5e5e5; margin: 4px 0;"></div>
      
      <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; gap: 10px;">
        <label for="outline-toggle" style="margin: 0;">Convert to Outline Stroke + Flatten</label>
        <div class="toggle-switch" id="outline-toggle"></div>
      </div>
    </div>
  </div>
  
  <div class="actions">
    <button class="btn-primary" id="create-component" disabled>Create Component</button>
    <button class="btn-secondary" id="cancel">Cancel</button>
  </div>
  
<script>
    let variants = [];
    let hasSelection = false;
    let strokeEnabled = false;
    let outlineFlattenEnabled = false;
    
    // Update stroke inputs based on global toggle
    // This function is called when toggle changes to re-render variants
    function updateStrokeInputs() {
      // The inputs are shown/hidden by re-rendering variants
      // This function is kept for compatibility but renderVariants handles visibility
    }
    
    // Save configuration to plugin storage
    function saveConfig() {
      const config = {
        componentName: document.getElementById('component-name').value,
        propertyName: document.getElementById('property-name').value,
        variants: variants,
        strokeEnabled: strokeEnabled,
        outlineFlattenEnabled: outlineFlattenEnabled
      };
      parent.postMessage({
        pluginMessage: {
          type: 'save-config',
          config: config
        }
      }, '*');
    }
    
    // Load configuration from plugin storage
    function loadConfig(config) {
      if (!config) {
        // Set defaults if no config
        const componentNameInput = document.getElementById('component-name');
        const propertyNameInput = document.getElementById('property-name');
        if (componentNameInput && !componentNameInput.value) {
          componentNameInput.value = 'Icon Component';
        }
        if (propertyNameInput && !propertyNameInput.value) {
          propertyNameInput.value = 'Size';
        }
        if (variants.length === 0) {
          variants.push({ name: 'Small', size: 16 });
          renderVariants();
          updateCreateButton();
        }
        saveConfig();
        return;
      }
      
      // Restore component name
      const componentNameInput = document.getElementById('component-name');
      if (config.componentName && componentNameInput) {
        componentNameInput.value = config.componentName;
      } else if (componentNameInput && !componentNameInput.value) {
        componentNameInput.value = 'Icon Component';
      }
      
      // Restore property name
      const propertyNameInput = document.getElementById('property-name');
      if (config.propertyName && propertyNameInput) {
        propertyNameInput.value = config.propertyName;
      } else if (propertyNameInput && !propertyNameInput.value) {
        propertyNameInput.value = 'Size';
      }
      
      // Restore stroke toggle state
      if (config.strokeEnabled !== undefined) {
        strokeEnabled = config.strokeEnabled;
        const toggle = document.getElementById('stroke-toggle');
        if (toggle) {
          if (strokeEnabled) {
            toggle.classList.add('active');
          } else {
            toggle.classList.remove('active');
          }
        }
      }
      
      // Restore outline flatten toggle state
      if (config.outlineFlattenEnabled !== undefined) {
        outlineFlattenEnabled = config.outlineFlattenEnabled;
        const outlineToggle = document.getElementById('outline-toggle');
        if (outlineToggle) {
          if (outlineFlattenEnabled) {
            outlineToggle.classList.add('active');
          } else {
            outlineToggle.classList.remove('active');
          }
        }
      }
      
      // Restore variants
      if (config.variants && Array.isArray(config.variants) && config.variants.length > 0) {
        variants = config.variants.map(v => ({
          name: v.name || '',
          size: v.size || 16,
          stroke: v.stroke
        }));
        renderVariants();
        updateCreateButton();
      } else if (variants.length === 0) {
        variants.push({ name: 'Small', size: 16 });
        renderVariants();
        updateCreateButton();
      }
      
      updateStrokeInputs();
    }
    
    // Request config from plugin on load
    function initialize() {
      parent.postMessage({
        pluginMessage: {
          type: 'request-config'
        }
      }, '*');
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }
    
    // Listen for messages from plugin
    window.addEventListener('message', (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'load-config') {
        loadConfig(msg.config);
        return;
      }
      
      if (msg.type === 'selection-changed') {
        hasSelection = msg.hasSelection;
        const infoBox = document.getElementById('info-box');
        const createBtn = document.getElementById('create-component');
        
        if (hasSelection) {
          infoBox.textContent = `Selected: ${msg.selectionName}`;
          infoBox.className = 'info-box';
          createBtn.disabled = variants.length === 0;
        } else {
          infoBox.textContent = 'Please select an icon in Figma';
          infoBox.className = 'info-box warning';
          createBtn.disabled = true;
        }
      }
    });
    
    function renderVariants() {
      const container = document.getElementById('variants-list');
      container.innerHTML = '';
      
      variants.forEach((variant, index) => {
        const item = document.createElement('div');
        item.className = 'variant-item';
        item.innerHTML = `
          <input type="text" 
                 class="variant-name" 
                 placeholder="Variant name" 
                 value="${variant.name}"
                 data-index="${index}">
          <input type="number" 
                 class="variant-size" 
                 placeholder="Size" 
                 value="${variant.size}"
                 min="1"
                 data-index="${index}">
          ${strokeEnabled ? `
          <input type="number" 
                 class="variant-size stroke-input" 
                 placeholder="Stroke" 
                 value="${variant.stroke || ''}"
                 min="0"
                 step="0.5"
                 data-index="${index}">
          ` : ''}
          <button class="remove-btn" data-index="${index}" aria-label="Remove variant">
            <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
          </button>
        `;
        container.appendChild(item);
      });
      
      // Add event listeners
      document.querySelectorAll('.variant-name').forEach(input => {
        input.addEventListener('input', (e) => {
          const index = parseInt(e.target.dataset.index);
          variants[index].name = e.target.value;
          saveConfig();
        });
      });
      
      document.querySelectorAll('.variant-size:not(.stroke-input)').forEach(input => {
        input.addEventListener('input', (e) => {
          const index = parseInt(e.target.dataset.index);
          variants[index].size = parseInt(e.target.value) || 0;
          saveConfig();
        });
      });
      
      // Don't set default stroke values - leave empty for user to fill
      
      document.querySelectorAll('.stroke-input').forEach(input => {
        input.addEventListener('input', (e) => {
          const index = parseInt(e.target.dataset.index);
          const strokeValue = parseFloat(e.target.value);
          variants[index].stroke = isNaN(strokeValue) || strokeValue <= 0 ? undefined : strokeValue;
          saveConfig();
        });
      });
      
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          variants.splice(index, 1);
          renderVariants();
          updateCreateButton();
          saveConfig();
        });
      });
    }
    
    function updateCreateButton() {
      const createBtn = document.getElementById('create-component');
      const hasValidVariants = variants.length > 0 && 
        variants.every(v => v.name.trim() && v.size > 0);
      createBtn.disabled = !hasSelection || !hasValidVariants;
    }
    
    // Global stroke toggle
    document.getElementById('stroke-toggle').addEventListener('click', () => {
      strokeEnabled = !strokeEnabled;
      const toggle = document.getElementById('stroke-toggle');
      if (strokeEnabled) {
        toggle.classList.add('active');
        // Don't set default stroke values - leave empty for user to fill
      } else {
        toggle.classList.remove('active');
        // Clear stroke values
        variants.forEach(variant => {
          variant.stroke = undefined;
        });
      }
      // Re-render variants to show/hide stroke inputs
      renderVariants();
      saveConfig();
    });
    
    // Global outline flatten toggle
    document.getElementById('outline-toggle').addEventListener('click', () => {
      outlineFlattenEnabled = !outlineFlattenEnabled;
      const toggle = document.getElementById('outline-toggle');
      if (outlineFlattenEnabled) {
        toggle.classList.add('active');
      } else {
        toggle.classList.remove('active');
      }
      saveConfig();
    });
    
    // Save config when component name or property name changes
    document.getElementById('component-name').addEventListener('input', saveConfig);
    document.getElementById('property-name').addEventListener('input', saveConfig);
    
    document.getElementById('add-variant').addEventListener('click', () => {
      const defaultSize = variants.length > 0 
        ? variants[variants.length - 1].size + 8 
        : 16;
      variants.push({
        name: `Size ${variants.length + 1}`,
        size: defaultSize,
        stroke: undefined
      });
      renderVariants();
      updateCreateButton();
      saveConfig();
    });
    
    document.getElementById('create-component').addEventListener('click', () => {
      const componentName = document.getElementById('component-name').value || 'Icon Component';
      const propertyName = document.getElementById('property-name').value || 'Size';
      
      if (variants.length === 0) {
        alert('Please add at least one variant');
        return;
      }
      
      const invalidVariants = variants.filter(v => !v.name.trim() || v.size <= 0);
      if (invalidVariants.length > 0) {
        alert('Please fill in all variant names and sizes');
        return;
      }
      
      if (!propertyName.trim()) {
        alert('Please enter a property name');
        return;
      }
      
      parent.postMessage({
        pluginMessage: {
          type: 'create-component',
          componentName: componentName,
          propertyName: propertyName,
          variants: variants,
          strokeEnabled: strokeEnabled,
          outlineFlattenEnabled: outlineFlattenEnabled
        }
      }, '*');
    });
    
    document.getElementById('cancel').addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    });
</script>
</body>
</html>
